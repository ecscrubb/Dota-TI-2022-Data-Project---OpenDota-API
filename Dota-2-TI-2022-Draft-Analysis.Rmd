---
title: "Dota 2 International 2022 Draft Analysis"
author: "Dave Whitsett"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
urlcolor: blue
---
```{r echo = FALSE, results = 'hide', error = FALSE, message = FALSE, warning = FALSE}

## LIBRARIES ##

library(jsonlite)
library(httr)
library(scales)
library(formattable)
library(plyr)
library(tidyverse)
library(wrapr)
library(lubridate)

## USEFUL FUNCTIONS ##

'%notin%' <- Negate('%in%')

## DATA WRANGLING ##

## First, I'll call up the TI 11 draft data I downloaded from the OpenDota
## API as described in the preamble.

ti_11_match_data <- readRDS("ti_11_match_data.RData")

## Next, I'll call up saved Hero vector to map hero names onto Hero IDs

heroes_raw <- readRDS("hero_map.RData")
heroes <- fromJSON(rawToChar(heroes_raw$content))
hero_name_map <- heroes %>%
  select(id, localized_name)

## Now, I'll map these hero names onto each of the drafts in the draft data
## list, since they're only saved there as numeric IDs

for (i in 1:231) {
  ti_11_match_data[[i]]$Picks_Bans$hero_name <- 
    mapvalues(ti_11_match_data[[i]]$Picks_Bans$hero_id,
              hero_name_map$id, hero_name_map$localized_name
              )
                  }

## Now let's create a data frame with all the data we want to analyze for our first
## few questions. First, we'll add basic draft info.

all_drafts <- as_tibble(ti_11_match_data[[1]]$Picks_Bans)

for (i in 2:231) {
  all_drafts <- rbind(all_drafts, as_tibble(ti_11_match_data[[i]]$Picks_Bans))
}

## Next, we'll add a "matchday" variable.

matchdays_raw <- day(with_tz(as_datetime(ti_11_match_data[[1]]$Time),
                         tz = "Singapore"))
for (i in 2:231) {
  matchdays_raw[i] <- day(with_tz(as_datetime(ti_11_match_data[[i]]$Time),
                              tz = "Singapore"))
}

for (i in 1:231) {
  if (matchdays_raw[i] %in% c(15:18)) {
    matchdays_raw[i] <- matchdays_raw[i] - 14
  } else if (matchdays_raw[i] %in% c(20:23)) {
    matchdays_raw[i] <- matchdays_raw[i] - 15
  } else {
    matchdays_raw[i] <- matchdays_raw[i] - 20
  }
}

matchdays <- c()

for (i in 1:231) {
  matchdays <- c(matchdays, rep(matchdays_raw[i], 24))
}

all_drafts$matchday <- matchdays

## "ord" and "order" are redundant and I'd rather they start at 1 rather
## than 0 to make the variable's value match the pick number.

all_drafts <- subset(all_drafts, select = -ord)

rename(all_drafts, pick = order)

all_drafts$order <- all_drafts$order + 1

## The draft occurs over distinct "phases," which it will be good to demarkate
## for later analyses.

phases_raw <- c(rep("ban_1", 4), rep("pick_1", 4), rep("ban_2", 6), rep("pick_2", 4)
                , rep("ban_3", 4), rep("pick_3"), 2)

phases <- rep(phases_raw, 231)

all_drafts$phase <- phases

## Finally, it will be important to know which team won each match, so let's
## create a variable for which side corresponds to each pick, as well as which
## side ultimately won each match, and the team name of the team that played
## that side for each match.

winning_sides_raw <- c()

for (i in 1:231) {
  winning_sides_raw[i] <- ifelse(ti_11_match_data[[i]]$Radiant_Win == TRUE,
                                 yes = "radiant", no = "dire")
}

winning_sides <- c()

for (i in 1:231) {
  winning_sides <- c(winning_sides, rep(winning_sides_raw[i], 24))
}

all_drafts$winning_side <- winning_sides

side_pick <- c()

for (i in 1:231) {
  side_pick <- c(side_pick, ti_11_match_data[[i]]$draft_timings$active_team)
}

rad_dire <- data.frame("dire" = 3, "radiant" = 2)

side_pick_names <- mapvalues(side_pick, rad_dire, names(rad_dire))

all_drafts$pick_side <- side_pick_names

all_drafts$result <- ifelse(all_drafts$pick_side == all_drafts$winning_side,
                            1, 0)

dire_teams <- c()
radiant_teams <- c()

for (i in 1:231) {
  dire_teams <- c(dire_teams, rep(ti_11_match_data[[i]]$Dire_Team$name, 24))
  radiant_teams <- c(radiant_teams, rep(ti_11_match_data[[i]]$Radiant_Team$name, 24))
}

all_drafts$dire_team <- dire_teams
all_drafts$radiant_team <- radiant_teams

for (i in 1:5544) {
  if (all_drafts$pick_side[i] == "dire") {
      all_drafts$pick_team[i] <- all_drafts$dire_team[i]
                                        }
  else (all_drafts$pick_team[i] <- all_drafts$radiant_team[i])
}

```

# Part 1: Introduction to Dota 2

## 1.1 The Basics

Dota 2 is a real-time strategy game game played online between two teams of five players each. Winning requires both long-term strategy and quick in-game decision-making, the combination of which is very attractive to people who, like me, love the intellectual challenge of pitting their wits against others on the strategic battlefield but find "pure" strategy games like chess a bit too slow-paced.

I won't go into an in-depth description of gameplay (those interested can find [a good summary by IGN here](https://www.ign.com/wikis/dota-2/Game_Overview)), but a few words about the basic structure of the game will help explain why it's especially interesting from a data analytic point of view. The name "Dota" is an acronym for "Defense Of The Ancient." The "Ancient" referred to in the name is a giant structure in the middle of each team's base. The "Dire" (red) team's Ancient is in the top-right corner of the map and the "Radiant" (green) team's Ancient is in the bottom-left corner. The goal of the game is to destroy the other team's Ancient before they destroy yours. Standing in the way of this goal are a series of towers - durable buildings that do heavy damage to anything that comes within range - as well as less-powerful minions that spawn regularly and behave predictably, and of course the opposing team. The map on which the games take place is always the same, and a simplified version is shown below.

&nbsp;  

![*Dota 2 Minimap (courtesy* [RepostIsNotOk](https://www.reddit.com/r/DotA2/comments/39pyiw/dota_2_handy_map_made_an_updated_version_hope_it/))](Dota_2_TI_11_Project_Images/Dota_2_Minimap.png){width=85%}

## 1.2 Heroes, Items, and "The Meta"

The map, goal, and minions are always the same, and relatively straightforward. The complexity of Dota 2 comes from which **heroes** each team selects and the **items** those heroes buy to give them certain powers. Each player controls one hero, and each hero comes with an innate set of attributes (health, speed, magic, damage, etc.) and abilities (spells, auras, passive bonuses, etc.) that can be leveled up as the hero participates in battle with minions and opposing heroes. Killing minions and opposing heroes also grants gold, which enables heroes to buy items, which convey bonuses to the hero/team that equips them. As of the time of writing in late 2022, there are 123 heroes, each with its own innate set of attributes and abilities, and 208 items, each of which provides its own benefits (and sometimes weaknesses). Since each *individual* hero can be played in a wide variety of ways (different skill focuses, different item builds) and the number of possible 5-hero *team* compositions is so high, there is a very wide range of potential strategies for players to pursue in their effort to destroy the other team's towers and ancients. And since Dota 2 is regularly "patched," with heroes' abilities and items' prices being adjusted, new heroes and items being added, the map being tweaked, etc., the "meta," or relative strength of different strategies, is always changing.

## 1.3 The Draft

A final wrinkle to fold into these layers of complexity is the ability to *ban* heroes. In casual public matches, each team can propose up to 5 heroes to ban entirely from the hero pool. The rest are available for selection on a first-come, first-served basis. In professional matches, this process is handled through the draft. The draft takes place *before* the map shown above even appears. It is a strategic selection process through which teams maneuver to get the heroes they want and - often just as important - prevent the other team from getting the heroes *they* want. There are six phases of the draft overall - three banning phases (where each team selects a couple heroes *nobody* is allowed to pick) and three picking phases (where each team takes turn picking *their own* heroes). This is the aspect of Dota 2 strategy I will be focusing on in my analysis for this project.

![*Picks and bans for the final match of TI 2022 between Tundra Esports and Team Secret. The large icons are picked heroes, while the smaller icons beneath them are banned heroes.*](C:/Users/Dave/OneDrive/Documents/R/R Data Projects/Dota TI 2022 Data Project - OpenDota API/Dota_2_TI_11_Project_Images/Tundra_Secret_g3_Picks){width=85%}

I will say more about drafting strategy as we work through the data together, but it seems wise to make a few preliminary notes. First, in professional games there are more *bans* than *picks,* and the first banning phase precedes the first picking phase. Second, the wide array of hero styles and game strategies available in Dota 2 mean that there are many opportunities for teams to counter the heroes the other team picks early in the draft. Together, this means that (a) there is a high premium on flexible, "all-around" heroes early in the draft and (b) we shouldn't expect the win rate for heroes who are almost always picked early in the draft to be much higher than 50\%. This is because, even if those heroes really *are* among the most powerful heroes in the "meta," the availability of so many picks and bans following their selection early in the draft gives them a higher hill to climb than heroes picked later in the draft, which teams can do less to counter. It also means that (c) in general, we should expect the heroes teams think most powerful to be banned more often than they are picked. This is simply because teams have more bans than picks, especially early in the draft where, by the end of the second banning phase, each team will have banned five heroes while only picking two.

## 1.4 The International

Every year, there is a large international tournament, aptly named "The International," or just "TI" for short, where the best Dota 2 teams in the world meet and vie for the title of best in the world (as well as for an [enormous lump of cash](https://www.statista.com/statistics/749033/dota-2-championships-prize-pool/)). This year (2022), 20 teams were involved in The International, which took place over two phases - the Group Phase and the Main Event. In the Group Phase, teams were divided into two groups of ten teams, and each team within each group played every other team twice. For the Main Event, the top four teams from each group moved on to start in the Upper Bracket of a double-elimination tournament of best-of-three matches, the next four teams started in the Lower Bracket, and the bottom two teams were eliminated. By the end of the tournament, 231 games had been played in total.

Because Dota is so complex, it is not easy even for the pros to discover a "dominant" strategy or set of strategies. Doing so requires teams to play a large number of matches in a given patch. Moreover, professional teams have an incentive to hide the strategies they think are the best from other pro teams until they compete in a prestigious tournament since the element of surprise is so valuable. Because of its immense prestige, elite skill level and enormous prize pool, The International offers the most likely scene for the most-dominant strategies to be developed and/or unveiled. And since there are so many matches, with data automatically captured for every match and stored in [OpenDota's API](https://docs.opendota.com/), The International represents a unique opportunity to use data to analyze the current "meta." That is the aim of this project.

# Part 2: Analysis of Overall Trends for TI 2022

I'll start by just summarizing a few of the overall trends over the course of the tournament as a whole. After that, I'll go into more depth analyzing trends over time and pursuing whatever questions seem interesting given our first glance at the overall trends.

## 2.1 Most Contested Heroes

In Dota 2, the term "contested" is an all-inclusive category meaning "picked OR banned." The most contested heroes are likely to be the heroes teams thought were the most powerful overall, as well as the most flexible. As such, the average draft position of many the most-contested heroes should also be early, since the most flexible and powerful heroes are likely to be picked or banned before those heroes whose utility is more situational, and could easily be countered by later picks and bans.

As the graphics below show, this is exactly the case. The first graphic shows how often the 25 most-contested heroes were picked or banned, while the second graphic shows the average draft position and total picks/bans of each of those heroes. As the second graphic illustrates, the more a hero was picked, on average (that is, the farther right it appears on the graph), the lower its average draft position (that is, the farther down it appears on the graph). If we think of the draft in terms of phases (which most analysts do), the median draft position of nine heroes is $<9$, which means those heroes were either first-phase banned or first-phase picked in the majority of the matches in which they were contested. An additional 10 heroes' median draft position is $<13$, which means they were generally either picked or banned before the second picking phase began.

&nbsp;  

```{r echo = FALSE, fig.height = 3.2}

all_drafts %>%
  group_by(hero_name) %>%
  summarize(total_contested = n(), appearances = sum(is_pick)) %>%
  arrange(desc(total_contested)) %>%
  slice(1:25) %>%

  ggplot(mapping = aes(y = reorder(hero_name, total_contested)
                      )
         ) +
    geom_bar(mapping = aes(x = total_contested), stat = "identity"
             , fill = "gold") +
    geom_bar(mapping = aes(x = appearances), stat = "identity"
             , fill = "gray30") +
    geom_text(mapping = aes(label = paste0(total_contested - appearances
                                          , " (", total_contested, ")"
                                          )
                            , x = total_contested
                            )
              , size = 2.5, hjust = 1.1, vjust = 0.4) +
    geom_text(mapping = aes(label = appearances, x = appearances)
              , size = 2.5, hjust = 1.3, vjust = 0.45, color = "white") +
    labs(x = "Picks vs Bans (Total Contestation)", y = NULL) +
    theme(legend.position = "none",
          panel.background = element_rect(fill = "white",
                                          color = "white"
                                          )
                            , axis.title.x = element_text(color = "grey25"
                                                          , size = 10)
          )

```

```{r echo = FALSE, fig.height = 3.2}

all_drafts %>%
  group_by(hero_name) %>%
  summarize(total_contested = n(), avg_pos = median(order, na.rm = TRUE)) %>%
  arrange(desc(total_contested)) %>%
  slice(1:25) %>%
  arrange(avg_pos) %>%
  
  ggplot(mapping = aes(x = total_contested, y = avg_pos)) +
    geom_point(mapping = aes(color = hero_name)) +
    geom_text(mapping = aes(label = hero_name, color = hero_name)
              , nudge_y = 0.7, size = 3.2
              ) +
    theme(legend.position = "none"
          , panel.background = element_rect(fill = "white"
                                            , color = "grey75"
                                            )
          , axis.title.x = element_text(color = "grey25", size = 10)
          , axis.title.y = element_text(color = "grey25", size = 10)
          ) +
    labs(x = "Total Contestation", y = "Average Draft Position")

```

A final point of interest is the relationship between hero *role* and draft position. Each of the five heroes on a given team has a unique role. Two heroes are "supports" (positions 4 and 5), which usually have all-around utility but do not scale into ultra-powerful heroes later in the game. The other heroes are "cores" (positions 1, 2, and 3) who scale better into the late game. Generally speaking, it is the job of the supports to take care of their cores in the early game so that they can scale into ultra-powerful heroes that ultimately take over the game and "carry" the team to victory. Due to the mechanics of the game and the nature of the draft, however, it is very difficult to guarantee that *all* the cores will be able to scale well. Teams can realistically only count on 1 or 2 of their cores to have a good enough early game to carry in the mid-to-late game. Because of this, teams usually wait to pick their key hero(es), or their "win condition(s)," until late in the draft. Usually, the "win condition" hero is played in position 1 or 2, though sometimes it can be position 3.

What this means is that supports are likely to dominate the earliest *picks* in the draft, joined by only the most powerful and difficult-to-counter win condition heroes in the patch. The same is not necessarily true for *bans,* however. Because they usually do not have the potential to carry a game on their own, supports are not as feared as the most powerful cores. We should, therefore, expect to see supports dominate the early *picks* of the draft, but not necessarily the early *bans.* On the other hand, cores should often be *banned* early but *picked* late. The only exceptions to this rule should be the few heroes commonly thought to be *so* strong that they are nearly impossible to counter. In Dota 2 lingo, these heroes are "overpowered," or "OP." Let's look at the data and see if this is the case.

```{r echo = FALSE, fig.height = 3.2}

all_drafts %>%
  group_by(hero_name) %>%
  summarize(total_contested = n(), appearances = sum(is_pick)
            , avg_pos = median(order, na.rm = TRUE)
            ) %>%
  arrange(desc(total_contested)) %>%
  slice(1:25) %>%
  arrange(avg_pos) %>%
  
  ggplot(mapping = aes(x = appearances/total_contested, y = avg_pos)) +
    geom_point(mapping = aes(color = hero_name)) +
    geom_text(mapping = aes(label = hero_name, color = hero_name)
              , nudge_y = 0.7, size = 3.2
              ) +
    geom_vline(xintercept = 0.4167, linetype = 2, color = "grey75") +
    theme(legend.position = "none"
          , panel.background = element_rect(fill = "white"
                                            , color = "grey75"
                                            )
          , axis.title.x = element_text(color = "grey25", size = 10)
          , axis.title.y = element_text(color = "grey25", size = 10)
          ) +
    labs(x = "Pick/Ban Ratio", y = "Average Draft Position")
  

```

The plot above compares the pick/ban ratio of the 25 most-contested heroes with their average draft position. The farther right on the graph, the more the hero was picked (as opposed to banned). The higher up on the graph, the later that hero's average draft position. The dashed vertical line represents a pick/ban ratio of 0.4167. This is because there are 10 picks and 14 bans in a single draft, i.e. picks make up $10/24 = 0.4167$ of the draft. Thus, heroes to the left of the line are *more* likely to be banned than picked, proportional to the total available picks vs. bans, while those to the right are *less.*

This plot clearly supports the hypotheses outlined above. All but one of the supports among the top-25 most-contested heroes (Snapfire, Silencer, Crystal Maiden, Tiny, Clockwerk, Nyx Assassin, Undying, and Marcy) fall to the right of the dashed line. The only "support" to the left is Primal Beast, who is often played as a core and only sometimes as a support. The majority of these supports also sport a low average draft position, with most a majority having been drafted before the 10th pick/ban (Snapfire is the only exception). Meanwhile, *all* the heroes to the left of the dashed line are cores, and most of them averaged a draft position of $>10$. In The International 2022, teams showed a strong propensity to *ban* cores early and *pick* them late, preferring to spend their early picks on supports.

## 2.2 Win Rates of Most Contested Heroes

Let's assume for now that the theory behind banning cores early and picking them late while picking supports early is sound (if I have time later, I'll put that question in the crosshairs). Even if so, did pros identify the *right* cores to ban vs. those to let through? Did they, in other words, successfully differentiate the cores that were most difficult to deal with from those who *could* be dealt with? If they did, we should expect the cores in the lower-left quadrant of the plot above to have a *higher* win rate than the cores in the lower-right quadrant. Let's see if that was the case.

```{r echo = FALSE, fig.height = 3.2}

all_drafts %>%
  filter(hero_name %in% c("Visage", "Broodmother", "Enigma", "Primal Beast"
                          , "Shadow Fiend", "Leshrac"
                          )
         ) %>%
  group_by(hero_name) %>%
  summarize(wins = sum(result[which(is_pick == 1)]), appearances = sum(is_pick)
            , win_rate = ((sum(result[which(is_pick == 1)]))/(sum(is_pick)))
            , bans = (n())-(sum(is_pick)), contestations = n()
            ) %>%
  arrange(desc(win_rate)) %>%
  
  ggplot(mapping = aes(x = win_rate, y = reorder(hero_name, win_rate))) +
    geom_bar(mapping = aes(x = contestations), stat = "identity"
             , fill = "lightblue2") +
    geom_bar(mapping = aes(x = appearances), stat = "identity"
             , fill = "slateblue4") +
    geom_text(mapping = aes(label = bans, x = contestations
                            , hjust = 1.5, vjust = 0.3)
              , size = 3
              ) +
    geom_text(mapping = aes(label = paste0(appearances, " ("
                                           , percent(win_rate, 0.1)
                                           , ")"
                                           )
                            , x = appearances, hjust = 1.1, vjust = 0.3
                            ), color = "white", size = 3
              ) +
    theme(legend.position = "none"
          , panel.background = element_rect(fill = "white"
                                            , color = "grey75"
                                            )
          , axis.title.x = element_text(color = "grey25", size = 10)
          , axis.title.y = element_text(color = "grey25", size = 10)
          ) +
    labs(x = "Picks (Win Rate) vs Bans", y = NULL)

```

The chart above compares the number of picks (dark blue bar) with the number of bans (light blue bar) for the six cores that fit the description above (average draft position $< 10$). They are listed in order of win rate, with the most-successful core (Broodmother 65\% win rate) on top and the least successful core (Primal Beast, 47\% win rate) on bottom. These numbers tell a mixed story. On the one hand, all but two of the heroes (Shadow Fiend and Primal Beast) boast a 50-plus percent win rate *despite* usually being picked early enough to give the opponent many opportunities to counter them. If a "win condition" hero is so strong that it regularly wins even *after* opponents have maximal opportunity to counter it, it makes sense to just ban it. And, for all of the heroes above except Leshrac and Shadow Fiend, this is exactly what pro teams tended to do.

```{r echo = FALSE, results = 'hide', message = FALSE}

## Code by which I obtained statistics in following paragraph

all_drafts %>%
  filter(hero_name == "Primal Beast" & order %in% 1:8) %>%
  summarize(first_ban = length(which(order %in% 1:4))
            , first_pick = length(which(order %in% 5:8))
            )

all_drafts %>%
  filter(hero_name == "Leshrac" & order %in% 1:8) %>%
  summarize(first_ban = length(which(order %in% 1:4))
            , first_pick = length(which(order %in% 5:8))
            )

```

However, the chart above also casts doubt on some aspects of pros' pick/ban prioritization. For one thing, the *most* successful hero in the tournament (support or core), Broodmother, was only picked 40 times overall and only banned 104 times. It was therefore neither picked nor banned in over one-third of all games despite its overwhelming win rate. Meanwhile, Primal Beast was banned in more than one-half of all games (125 times total) and picked in 67 others. The vast majority of these bans (114) and picks (59) took place in the first phase. Teams seemed to fear Primal Beast more than any other core, as no other core was banned so often in the first phase. Yet, in those games when Primal Beast *did* get through, the team that picked Primal Beast only wound up winning 47.8\% of the time. Leshrac, on the other hand, was banned only 72 times in total, with only 40 of these bans coming in the first phase. That is, Leshrac was about half as likely as Primal Beast to be banned overall and about one-third as likely to be banned in the first phase. Yet, Leshrac ended the tournament with a 57.14\% win rate despite usually being picked in the first phase (52 first-phase picks out of 77 total). These statistics seem to suggest that teams may have benefited from banning Leshrac instead of Primal Beast, and certainly should have picked/banned Broodmother more often.

Of course, the draft is more complicated than this. For one thing, draft order matters a *lot.* For instance, the team that picks first gets a single pick, while the next team gets two picks in a row. The second team might therefore choose to let *multiple* overpowered heroes through on purpose, conceding one to their rivals in order to get two themselves. And, of course, the team with first pick has little incentive to ban whatever hero they think is the *most* powerful because they'd rather pick it. On top of this, because bans are limited, there is always an opportunity cost to banning a given hero - banning *that* hero necessarily means *some other* hero, potentially a very strong one, has to be let through. And, of course, each team's will have their own style and their players will have certain heroes they are better and worse with. These factors could be more important than the innate skills and abilities of the heroes themselves. Because of this, we can't decisively conclude from the numbers above that teams were *wrong* to ban Primal Beast while letting Leshrac through. But we *can* test that hypothesis more directly by looking at the matches where precisely that happened.

One way of trying to get a clearer picture of this issue is to look at whether *banning* Leshrac and Broodmother and *not banning* Primal Beast in the first phase was really the right way of dealing with these heroes. It might seem straightforward, when looking at those heroes' *general* win rates, to conclude that teams should have banned Leshrac and let Primal Beast through. But in fact, the data strongly suggests the solution is not so simple. As it turns out, the win rate of teams who banned Primal Beast was 61.6\%, while the win rate of teams who banned Leshrac was only 47.2\% and the win rate of teams that banned Broodmother was a dismal 41.3\%.

```{r echo = FALSE, message = FALSE, fig.height = 3.2}

all_drafts %>%
  filter(hero_name %in% c("Broodmother", "Leshrac", "Primal Beast") &
           phase %in% c("ban_1", "pick_1", "ban_2", "pick_2")
         ) %>%
  mutate(phase = factor(phase, levels = c("ban_1", "pick_1", "ban_2", "pick_2"))
         ) %>%
  group_by(hero_name, phase) %>%
  summarize(total = n(), win_rate = mean(result)) %>%
  
  ggplot() +
    geom_hline(yintercept = 0.5, linetype = 2, color = "grey85") +
    geom_bar(mapping = aes(x = hero_name, y = win_rate, fill = phase)
             , stat = "identity", position = "dodge") +
    geom_text(mapping = aes(x = hero_name, y = win_rate
                            , label = percent(win_rate, 0.1)
                            , group = phase)
              , position = position_dodge(width = 0.9), vjust = -2.2
              , size = 2.4, color = "grey25"
              ) +
    geom_text(mapping = aes(x = hero_name, y = win_rate
                  , label = paste0("(", total, ")")
                  , group = phase)
              , position = position_dodge(width = 0.9), vjust = -0.5
              , size = 2.4, color = "grey25"
              ) +
    ylim(0, 1) +
    scale_fill_manual(values = c("orangered", "palegreen2", "orangered4"
                                 , "palegreen4")
                      , name = "Draft Phase"
                      , breaks = c("ban_1", "pick_1", "ban_2", "pick_2")
                      , labels = c("Phase 1 Ban", "Phase 1 Pick", "Phase 2 Ban"
                                   , "Phase 2 Pick")
                      ) +
    labs(x = "Win Rate by Phase (Total Games)"
         , y = "Total Games") +
    theme(panel.background = element_rect(fill = "white"
                                            , color = "grey75"
                                            )
          , axis.title.x = element_text(color = "grey25", size = 10)
          , axis.title.y = element_text(color = "grey25", size = 10)
          , legend.title = element_text(color = "grey25", size = 10)
          , legend.title.align = 0.5
          , legend.text = element_text(color = "grey25")
          )

```

The chart above compares the win rate of teams who *banned* Broodmother, Leshrac, or Primal Beast (red bars) in the first (light red) or second (dark red) banning phase of the draft with the win rate of teams who *picked* those heroes (green bars) in the first (light green) or second (dark green) picking phase. The dashed line represents a 50\% win rate. Surprisingly, the red bars for Broodmother and Leshrac are *lower* than the dashed line, which means teams that banned those hero in the 1st/2nd phase were more likely to lose than win - often a *lot* more likely - despite the tendency of teams who *picked* those heroes to win. The opposite is true for Primal Beast. Teams who *banned* Primal Beast in the first phase were *much* more likely to win than lose, despite the fact that teams that picked were more likely to lose than win (I decline to draw any conclusions from Primal Beast's 2nd/3rd phase stats because eight games is too small a sample size for reliable inference). The single most shocking statistic in this chart is the relationship between banning vs. picking Broodmother in the 2nd phase. Broodmothers picked in the 2nd phase won an incredible 79\% of their games, yet teams who *banned* Broodmother in the 2nd phase still lost a whopping 60\% of the games in which they did so.

How can we explain this seemingly bizarre finding? Perhaps the answer can be found by making our analysis even *more* granular, and looking at the specific *pick order,* rather than *draft phases.* As I mentioned earlier, in TI 2022, the team that picked first had to wait for the opponents to pick twice before they got to pick again. Maybe the reason banning Primal Beast was a good idea while banning Broodmother and/or Leshrac was not had to do with the dynamics of the first phase, where one could argue it was better to let several overpowered heroes through in order to guarantee either that *your* team got the *most* overpowered hero (this seems to make the most sense for first-pick teams) or that your team got *two* overpowered heroes while the other team only got one (this seems to makes the most sense for second-pick teams). Let's break the data for these three heroes down further and see if we can test these hypotheses.

```{r echo = FALSE, message = FALSE, results = 'hide'}

## At this point it seems clear that creating a vector of the most-contested
## heroes would be a prudent shortcut, so I'll do that here.

most_contested <- all_drafts %>%
  group_by(hero_name) %>%
  filter(n() >= 81)

```

```{r echo = FALSE, message = FALSE}

all_drafts %>%
  filter(hero_name %in% c("Broodmother", "Leshrac", "Primal Beast") &
         order %in% 5:8) %>%
  mutate(order = fct_relevel(case_when(order == 5 ~ "Pick 1"
                                     , order %in% 6:7 ~ "Picks 2 & 3"
                                    , order == 8 ~ "Pick 4"
                                      )
                             , "Pick 1", "Picks 2 & 3", "Pick 4"
                            )
          ) %>%
  group_by(hero_name, order) %>%
  summarize(games = n(), win_rate = mean(result)) %>%
  
  ggplot() +
    
    geom_hline(yintercept = 0.5, linetype = 2, color = "grey85") +
    geom_bar(mapping = aes(x = hero_name, y = win_rate, fill = order)
             , stat = "identity", position = "dodge"
             ) +
    geom_text(mapping = aes(x = hero_name, y = win_rate
                            , label = percent(win_rate, 0.1)
                            , group = order
                            )
              , position = position_dodge(width = 0.9), vjust = -2.6
              , size = 3.7, color = "grey25"
              ) +
    geom_text(mapping = aes(x = hero_name, y = win_rate
                            , label = paste0("(", games, ")")
                            , group = order)
              , position = position_dodge(width = 0.9), vjust = -.9
              , size = 3.7, color = "grey25"
              ) +
    labs(x = "Win Rate by Pick Number (Total Picks)", y = "Win Rate") +
    scale_fill_manual(values = c("darkolivegreen3", "chocolate2"
                                 , "darkolivegreen3"), name = "Pick"
                      , breaks = c("Pick 1", "Picks 2 & 3", "Pick 4")
                      ) +
    ylim(0, 1) +
    theme(panel.background = element_rect(fill = "white"
                                            , color = "grey75"
                                            )
          , axis.title.x = element_text(color = "grey25", size = 10)
          , axis.title.y = element_text(color = "grey25", size = 10)
          , legend.title = element_text(color = "grey25", size = 10)
          , legend.title.align = 0.5
          , legend.text = element_text(color = "grey25")
          )
    

```

```{r echo = FALSE, message = FALSE, fig.height = 5.75}

most_contested %>%
  group_by(hero_name) %>%
  filter(n() > 120 & phase %in% c("ban_1", "pick_1", "ban_2", "pick_2")
         ) %>%
  group_by(hero_name, phase) %>%
  summarize(total = n(), win_rate = mean(result)) %>%
  
  ggplot() +
    geom_vline(xintercept = 0.5, linetype = 2, color = "grey85") +
    geom_bar(mapping = aes(y = hero_name, x = win_rate, fill = phase)
             , stat = "identity", position = "dodge") +
    geom_text(mapping = aes(y = hero_name, x = win_rate
                            , label = percent(win_rate, 0.1)
                            , group = phase), hjust = -0.6
              , position = position_dodge(width = 0.9)
              , size = 2.2, color = "grey25"
              ) +
    geom_text(mapping = aes(y = hero_name, x = win_rate
                  , label = paste0("(", total, ")")
                  , group = phase), hjust = 0.6
              , position = position_dodge(width = 0.9)
              , size = 2.2, color = "grey25"
              ) +
    xlim(0, 1) +
    labs(x = "Win Rate by Phase (Total Games)"
         , y = "Total Games") +
    theme(panel.background = element_rect(fill = "white"
                                            , color = "grey75"
                                            )
          , axis.title.x = element_text(color = "grey25", size = 10)
          , axis.title.y = element_text(color = "grey25", size = 10)
          , legend.title = element_text(color = "grey25", size = 10)
          , legend.title.align = 0.5
          , legend.text = element_text(color = "grey25")
          )

```

These results seem truly perplexing. Just how perplexing can be shown by boiling down their chief implication to a single sentence: In the International 2022, banning the most-successful heroes was, on average, a *losing strategy.*

```{r echo = FALSE, fig.height = 3.2}

all_drafts %>%
  group_by(hero_name) %>%
  filter(n() > 90) %>%
  summarize(appearances = sum(is_pick), bans = (n() - sum(is_pick))
            , picker_win_rate = (sum(result[which(is_pick == 1)])/sum(is_pick))
            , banner_win_rate = (sum(result[which(is_pick == 0)])/sum(is_pick))
            ) %>%
  arrange(desc(appearances)) %>%

  ggplot(mapping = aes(y = reorder(hero_name, appearances))) +
    geom_bar(mapping = aes(x = appearances)
             , stat = "identity", fill = "powderblue"
             ) +
    geom_bar(mapping = aes(x = appearances*picker_win_rate)
             , stat = "identity", fill = "lightsalmon4"
             ) +
    geom_text(mapping = aes(x = appearances, label = appearances, hjust = 1.3,
                            vjust = 0.45
                            )
              , size = 2.4
              ) +
    geom_text(mapping = aes(x = picker_win_rate*appearances
                            , hjust = 1.1, vjust = 0.45,
                    label = paste0(picker_win_rate * appearances, " ", "(",
                                  percent(picker_win_rate, .1), ")"
                                   )
                            ), color = "white", size = 2.4
              ) +
    theme(legend.position = "none"
          , panel.background = element_rect(fill = "white", color = "grey75")
          , axis.title.x = element_text(color = "grey25", size = 10)
          , axis.title.y = element_text(color = "grey25", size = 10)
          ) +
    labs(x = "Wins (Win Rate) vs Total Appearances", y = NULL)

```