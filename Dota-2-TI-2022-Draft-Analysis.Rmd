---
title: "Dota 2 TI11 Draft Analysis"
author: "Dave Whitsett"
date: "`r Sys.Date()`"
output: pdf_document
urlcolor: blue
    
---
```{r echo = FALSE, results = 'hide', error = FALSE, message = FALSE, warning = FALSE}

## LIBRARIES ##

library(jsonlite)
library(httr)
library(scales)
library(plyr)
library(tidyverse)
library(wrapr)
library(lubridate)

## DATA WRANGLING ##

## First, I'll call up the TI 11 draft data I downloaded from the OpenDota
## API as described in the preamble.

ti_11_match_data <- readRDS("ti_11_match_data.RData")

## Next, I'll call up saved Hero vector to map hero names onto Hero IDs

heroes_raw <- readRDS("hero_map.RData")
heroes <- fromJSON(rawToChar(heroes_raw$content))
hero_name_map <- heroes %>%
  select(id, localized_name)

## Now, I'll map these hero names onto each of the drafts in the draft data
## list, since they're only saved there as numeric IDs

for (i in 1:231) {
  ti_11_match_data[[i]]$Picks_Bans$hero_name <- 
    mapvalues(ti_11_match_data[[i]]$Picks_Bans$hero_id,
              hero_name_map$id, hero_name_map$localized_name
              )
                  }

## Now let's create a data frame with all the data we want to analyze for our first
## few questions. First, we'll add basic draft info.

all_drafts <- as_tibble(ti_11_match_data[[1]]$Picks_Bans)

for (i in 2:231) {
  all_drafts <- rbind(all_drafts, as_tibble(ti_11_match_data[[i]]$Picks_Bans))
}

## Next, we'll add a "matchday" variable.

matchdays_raw <- day(with_tz(as_datetime(ti_11_match_data[[1]]$Time),
                         tz = "Singapore"))
for (i in 2:231) {
  matchdays_raw[i] <- day(with_tz(as_datetime(ti_11_match_data[[i]]$Time),
                              tz = "Singapore"))
}

for (i in 1:231) {
  if (matchdays_raw[i] %in% c(15:18)) {
    matchdays_raw[i] <- matchdays_raw[i] - 14
  } else if (matchdays_raw[i] %in% c(20:23)) {
    matchdays_raw[i] <- matchdays_raw[i] - 15
  } else {
    matchdays_raw[i] <- matchdays_raw[i] - 20
  }
}

matchdays <- c()

for (i in 1:231) {
  matchdays <- c(matchdays, rep(matchdays_raw[i], 24))
}

all_drafts$matchday <- matchdays

## "ord" and "order" are redundant and I'd rather they start at 1 rather
## than 0 to make the variable's value match the pick number.

all_drafts <- subset(all_drafts, select = -ord)

rename(all_drafts, pick = order)

## The draft occurs over distinct "phases," which it will be good to demarkate
## for later analyses.

phases_raw <- c(rep("ban_1", 4), rep("pick_1", 4), rep("ban_2", 6), rep("pick_2", 4)
                , rep("ban_3", 4), rep("pick_3"), 2)

phases <- rep(phases_raw, 231)

all_drafts$phase <- phases

## Finally, it will be important to know which team won each match, so let's
## create a variable for which side corresponds to each pick, as well as which
## side ultimately won each match, and the team name of the team that played
## that side for each match.

winning_sides_raw <- c()

for (i in 1:231) {
  winning_sides_raw[i] <- ifelse(ti_11_match_data[[i]]$Radiant_Win == TRUE,
                                 yes = "radiant", no = "dire")
}

winning_sides <- c()

for (i in 1:231) {
  winning_sides <- c(winning_sides, rep(winning_sides_raw[i], 24))
}

all_drafts$winning_side <- winning_sides

side_pick <- c()

for (i in 1:231) {
  side_pick <- c(side_pick, ti_11_match_data[[i]]$draft_timings$active_team)
}

rad_dire <- data.frame("dire" = 3, "radiant" = 2)

side_pick_names <- mapvalues(side_pick, rad_dire, names(rad_dire))

all_drafts$pick_side <- side_pick_names

all_drafts$result <- ifelse(all_drafts$pick_side == all_drafts$winning_side,
                            1, 0)

dire_teams <- c()
radiant_teams <- c()

for (i in 1:231) {
  dire_teams <- c(dire_teams, rep(ti_11_match_data[[i]]$Dire_Team$name, 24))
  radiant_teams <- c(radiant_teams, rep(ti_11_match_data[[i]]$Radiant_Team$name, 24))
}

all_drafts$dire_team <- dire_teams
all_drafts$radiant_team <- radiant_teams

for (i in 1:5544) {
  if (all_drafts$pick_side[i] == "dire") {
      all_drafts$pick_team[i] <- all_drafts$dire_team[i]
                                        }
  else (all_drafts$pick_team[i] <- all_drafts$radiant_team[i])
}

```

# Part One: Introduction to Dota 2

## The Basics

Dota 2 is a real-time strategy game game played online between two teams of five players each. Winning requires both long-term strategy and quick in-game decision-making, the combination of which is very attractive to people who, like me, love the intellectual challenge of pitting their wits against others on the strategic battlefield but find "pure" strategy games like chess a bit too slow-paced.

I won't go into an in-depth description of gameplay (those interested can find [a good summary by IGN here](https://www.ign.com/wikis/dota-2/Game_Overview)), but a few words about the basic structure of the game will help explain why it's especially interesting from a data analytic point of view. The name "Dota" is an acronym for "Defense Of The Ancient." The "Ancient" referred to in the name is a giant structure in the middle of each team's base. The "Dire" (red) team's Ancient is in the top-right corner of the map and the "Radiant" (green) team's Ancient is in the bottom-left corner. The goal of the game is to destroy the other team's Ancient before they destroy yours. Standing in the way of this goal are a series of towers - durable buildings that do heavy damage to anything that comes within range - as well as less-powerful minions that spawn regularly and behave predictably, and of course the opposing team. The map on which the games take place is always the same, and a simplified version is shown below.

&nbsp;  

![*Dota 2 Minimap (courtesy* [RepostIsNotOk](https://www.reddit.com/r/DotA2/comments/39pyiw/dota_2_handy_map_made_an_updated_version_hope_it/))](Dota_2_TI_11_Project_Images/Dota_2_Minimap.png){width=85%}

## Heroes, Items, and "The Meta"

The map, goal, and minions are always the same, and relatively straightforward. The complexity of Dota 2 comes from which **heroes** each team selects and the **items** those heroes buy to give them certain powers. Each player controls one hero, and each hero comes with an innate set of attributes (health, speed, magic, damage, etc.) and abilities (spells, auras, passive bonuses, etc.) that can be leveled up as the hero participates in battle with minions and opposing heroes. Killing minions and opposing heroes also grants gold, which enables heroes to buy items, which convey bonuses to the hero/team that equips them. As of the time of writing in late 2022, there are 123 heroes, each with its own innate set of attributes and abilities, and 208 items, each of which provides its own benefits (and sometimes weaknesses). Since each *individual* hero can be played in a wide variety of ways (different skill focuses, different item builds) and the number of possible 5-hero *team* compositions is so high, there is a very wide range of potential strategies for players to pursue in their effort to destroy the other team's towers and ancients. And since Dota 2 is regularly "patched," with heroes' abilities and items' prices being adjusted, new heroes and items being added, the map being tweaked, etc., the "meta," or relative strength of different strategies, is always changing.

## The Draft

A final wrinkle to fold into these layers of complexity is the ability to *ban* heroes. In casual public matches, each team can propose up to 5 heroes to ban entirely from the hero pool. The rest are available for selection on a first-come, first-served basis. In professional matches, this process is handled through the draft. The draft takes place *before* the map shown above even appears. It is a strategic selection process through which teams maneuver to get the heroes they want and - often just as important - prevent the other team from getting the heroes *they* want. There are six phases of the draft overall - three banning phases (where each team selects a couple heroes *nobody* is allowed to pick) and three picking phases (where each team takes turn picking *their own* heroes). This is the aspect of Dota 2 strategy I will be focusing on in my analysis for this project.

![*Picks and bans for the final match of TI 2022 between Tundra Esports and Team Secret. The large icons are picked heroes, while the smaller icons beneath them are banned heroes.*](C:/Users/Dave/OneDrive/Documents/R/R Data Projects/Dota TI 2022 Data Project - OpenDota API/Dota_2_TI_11_Project_Images/Tundra_Secret_g3_Picks){width=85%}

I will say more about drafting strategy as we work through the data together, but it seems wise to make a few preliminary notes. First, in professional games there are more *bans* than *picks,* and the first banning phase precedes the first picking phase. Second, the wide array of hero styles and game strategies available in Dota 2 mean that there are many opportunities for teams to counter the heroes the other team picks early in the draft. Together, this means that (a) there is a high premium on flexible, "all-around" heroes early in the draft and (b) we shouldn't expect the win rate for heroes who are almost always picked early in the draft to be much higher than 50\%. This is because, even if those heroes really *are* among the most powerful heroes in the "meta," the availability of so many picks and bans following their selection early in the draft gives them a higher hill to climb than heroes picked later in the draft, which teams can do less to counter. It also means that (c) in general, we should expect the heroes teams think most powerful to be banned more often than they are picked. This is simply because teams have more bans than picks, especially early in the draft where, by the end of the second banning phase, each team will have banned five heroes while only picking two.

## The International

Every year, there is a large international tournament, aptly named "The International," or just "TI" for short, where the best Dota 2 teams in the world meet and vie for the title of best in the world (as well as for an [enormous lump of cash](https://www.statista.com/statistics/749033/dota-2-championships-prize-pool/)). This year (2022), 20 teams were involved in The International, which took place over two phases - the Group Phase and the Main Event. In the Group Phase, teams were divided into two groups of ten teams, and each team within each group played every other team twice. For the Main Event, the top four teams from each group moved on to start in the Upper Bracket of a double-elimination tournament of best-of-three matches, the next four teams started in the Lower Bracket, and the bottom two teams were eliminated. By the end of the tournament, 231 games had been played in total.

Since there are so many matches between the very best players in the world, The International represents a unique opportunity to use data to analyze the current "meta." That is the aim of this project.

# Part Two: Analysis of Overall Trends

I'll start by just summarizing a few of the overall trends over the course of the tournament as a whole. After that, I'll go into more depth analyzing trends over time and pursuing whatever questions seem interesting given our first glance at the overall trends.

## Most Contested Heroes

In Dota 2, the term "contested" is an all-inclusive category meaning "picked OR banned." The most contested heroes are likely to be the heroes teams thought were the most powerful overall, as well as the most flexible. As such, the average draft position of the most-contested heroes should also be early, since the most flexible and powerful heroes are likely to be picked before those heroes whose utility is more situational. As the graphics below show, this is exactly the case. The first graphic shows how often the 25 most-contested heroes were picked or banned, while the second graphic shows the average draft position and total picks/bans of each of those heroes. As the second graphic illustrates, the more a hero was picked, on average (that is, the farther right it appears on the graph), the lower its average draft position (that is, the farther down it appears on the graph). If we think of the draft in terms of phases (which most analysts do), the median draft position of 9 heroes is below 8, which means those heroes were either first-phase banned or first-phase picked in the majority of the matches in which they were contested. An additional 10 heroes' median draft position is below 13, which means they were generally either picked or banned before the second picking phase began.

&nbsp;  

```{r echo = FALSE, fig.height = 3.5}

all_drafts %>%
  group_by(hero_name) %>%
  summarize(total_contested = n()) %>%
  arrange(desc(total_contested)) %>%
  slice(1:25) %>%

  ggplot(mapping = aes(x = total_contested,
                       y = reorder(hero_name, total_contested)
                      )
         ) +
    geom_bar(mapping = aes(fill = hero_name),stat = "identity") +
    geom_text(mapping = aes(label = total_contested),
              size = 3, hjust = 2, vjust = 0.35) +
    labs(x = "TI 2022 - Total Picks/Bans", y = NULL) +
    theme(legend.position = "none",
          panel.background = element_rect(fill = "white",
                                          color = "white"
                                          )
                            , axis.title.x = element_text(color = "grey25"
                                                          , size = 10)
          )

```

```{r echo = FALSE, fig.height = 3.5}

all_drafts %>%
  group_by(hero_name) %>%
  summarize(total_contested = n(), avg_pos = median(order, na.rm = TRUE)) %>%
  arrange(desc(total_contested)) %>%
  slice(1:25) %>%
  arrange(avg_pos) %>%
  
  ggplot(mapping = aes(x = total_contested, y = avg_pos)) +
    geom_point(mapping = aes(color = hero_name)) +
    geom_text(mapping = aes(label = hero_name, color = hero_name)
              , nudge_y = 0.7, size = 3.5
              ) +
    theme(legend.position = "none"
          , panel.background = element_rect(fill = "white"
                                            , color = "grey75"
                                            )
          , axis.title.x = element_text(color = "grey25", size = 10)
          , axis.title.y = element_text(color = "grey25", size = 10)
          ) +
    labs(x = "Total Picks/Bans", y = "Average Draft Position")

```